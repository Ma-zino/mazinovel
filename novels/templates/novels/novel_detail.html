{% extends "base.html" %}
{% load static %}

{% block title %}{{ novel.title }} - Novel Details{% endblock title %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'novels/css/novel_detail.css' %}">
    {# SVG Icons are now in base.html #}
{% endblock extra_head %}

{% block content %}

{# --- Breadcrumb Container --- #}
<div class="breadcrumb-container">
    <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'novels:novel_list' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="#">Fantasy</a></li> {# Placeholder Genre #}
        <li class="breadcrumb-item">{{ novel.title }}</li>
    </ul>
</div>

{# --- Main Content Wrapper --- #}
<div class="main-content">
    {# --- Novel Header Section (Cover + Info Grid) --- #}
    <div class="novel-header">
        <div class="novel-cover">
            {% if novel.cover_image %} <img src="{{ novel.cover_image.url }}" alt="Cover for {{ novel.title }}">
            {% else %} <img src="{% static 'novels/images/placeholder.png' %}" alt="Placeholder Cover">
            {% endif %}
            <div class="cover-badges">
                <span class="badge badge-main-type">ORIGINAL</span>
            </div>
        </div>
        <div class="novel-info">
            <h1 class="novel-title">{{ novel.title }}</h1>
            <div class="novel-meta">
                <div class="meta-item genre-item"><span>Fantasy</span></div>
                <div class="meta-item chapters-item">
                     <svg class="stat-icon"><use xlink:href="#icon-chapters"></use></svg>
                    <span>{{ novel.chapters.count }} Chapters</span>
                </div>
                <div class="meta-item views-item">
                    <svg class="stat-icon"><use xlink:href="#icon-views"></use></svg>
                    <span>{{ novel.view_count }} Views</span>
                </div>
            </div>
            <div class="author-info">
                <span>Author:</span> <a href="#" class="author-name">{{ novel.author.username }}</a>
            </div>

            {# --- SIMPLIFIED Rating Display (Average Only) --- #}
            <div class="user-rating-section simplified-rating"> {# Added class #}
                <div class="rating-display-static">
                    <div class="stars-display" title="{{ novel.average_rating|default_if_none:'0.0' }}/5">
                         {% with avg=novel.average_rating|default_if_none:0.0 avg_floor=avg|stringformat:".0f"|add:"0" avg_diff=avg|floatformat:1|slice:"-1" %}
                             {% for i in "12345" %}
                                {% if i|add:"0" <= avg_floor %}<svg class="star-icon filled"><use xlink:href="#icon-star-filled"></use></svg>
                                {% elif i|add:"0" == avg_floor|add:"1" and avg_diff >= '5' %}<svg class="star-icon half"><use xlink:href="#icon-star-half"></use></svg>
                                {% else %}<svg class="star-icon empty"><use xlink:href="#icon-star-empty"></use></svg>
                                {% endif %}
                             {% endfor %}
                        {% endwith %}
                    </div>
                     <span class="rating-display-score">{{ novel.average_rating|default_if_none:"N/A" }}</span>
                     <span class="rating-display-count">({{ novel.rating_count }} ratings)</span>
                </div>
                 {# Login prompt removed from here - will be part of new review section #}
                 {# Form removed from here #}
            </div>
            {# --- END SIMPLIFIED Rating --- #}

            {# Action Buttons #}
            <div class="action-buttons">
                 {% with first_chapter=chapters.first %}
                    {% if first_chapter %}<a href="{{ first_chapter.get_absolute_url }}" class="btn btn-primary">READ</a>
                    {% else %}<a href="#" class="btn btn-primary disabled" aria-disabled="true">READ</a>
                    {% endif %}
                 {% endwith %}
                <button type="button" class="btn btn-secondary">ADD TO LIBRARY</button>
            </div>
            {# Report Link #}
            <div class="report-link"><a href="#">Report story</a></div>
        </div> {# End .novel-info #}
    </div> {# End .novel-header #}

    {# --- Tabs Section (About/Table of Contents) --- #}
    <div class="tabs-section">
        <div class="tab-nav">
            <button class="tab-btn active" data-tab-target="#about-tab" type="button">About</button>
            <button class="tab-btn" data-tab-target="#toc-tab" type="button">Table of Contents</button>
        </div>
        <div class="tab-content-wrapper">
            <div id="about-tab" class="tab-content active">
                <h3>Synopsis</h3>
                <div class="synopsis">{{ novel.synopsis|linebreaksbr }}</div>
            </div>
            <div id="toc-tab" class="tab-content">
                <h3>Chapters</h3>
                 {% if chapters %}
                    <ol class="chapter-list chapter-list-inline">
                         {% for chapter in chapters %}<li><a href="{{ chapter.get_absolute_url }}">Chapter {{ chapter.chapter_number }}{% if chapter.title %}: {{ chapter.title }}{% endif %}</a></li>{% endfor %}
                    </ol>
                 {% else %}<p>No chapters have been published for this novel yet.</p>
                 {% endif %}
            </div>
        </div> {# End .tab-content-wrapper #}
    </div> {# End .tabs-section #}


    {# --- START: NEW Review Section --- #}
    <section class="reviews-section">
        <h2>{{ novel.rating_count }} Reviews</h2> {# Dynamic count #}
        <div class="review-summary">
             {# Duplicate average display for emphasis #}
            <div class="summary-average">
                <span class="avg-score">{{ novel.average_rating|default_if_none:"0.0" }}</span>
                <div class="stars-display">
                     {% with avg=novel.average_rating|default_if_none:0.0 avg_floor=avg|stringformat:".0f"|add:"0" avg_diff=avg|floatformat:1|slice:"-1" %}
                        {% for i in "12345" %}
                           {% if i|add:"0" <= avg_floor %}<svg><use xlink:href="#icon-star-filled"></use></svg>
                           {% elif i|add:"0" == avg_floor|add:"1" and avg_diff >= '5' %}<svg><use xlink:href="#icon-star-half"></use></svg>
                           {% else %}<svg><use xlink:href="#icon-star-empty"></use></svg>
                           {% endif %}
                        {% endfor %}
                     {% endwith %}
                </div>
            </div>
             {# Criteria Breakdown - Placeholders, needs model fields later #}
             <div class="criteria-list">
                <div class="criterion-item">
                     <span class="criterion-label">Writing Quality</span>
                     <div class="stars-display criterion-stars"> {# Placeholder stars #} <svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-half"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg> </div>
                 </div>
                <div class="criterion-item">
                    <span class="criterion-label">Stability of Updates</span>
                    <div class="stars-display criterion-stars"> {# Placeholder stars #} <svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg> </div>
                </div>
                 <div class="criterion-item">
                     <span class="criterion-label">Story Development</span>
                     <div class="stars-display criterion-stars"> {# Placeholder stars #} <svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg> </div>
                 </div>
                 <div class="criterion-item">
                    <span class="criterion-label">Character Design</span>
                    <div class="stars-display criterion-stars"> {# Placeholder stars #} <svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg> </div>
                </div>
                 <div class="criterion-item">
                    <span class="criterion-label">World Background</span>
                     <div class="stars-display criterion-stars"> {# Placeholder stars #} <svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-filled"></use></svg><svg><use xlink:href="#icon-star-half"></use></svg> </div>
                 </div>
             </div>
            {# Write Review Button #}
            <div class="write-review-action">
                 {% if user.is_authenticated %}
                    <button type="button" class="btn write-review-btn" data-modal-target="#review-modal">Write a Review</button>
                 {% else %}
                    <a href="{% url 'login' %}?next={{ request.path|urlencode }}" class="btn write-review-btn">Login to Review</a>
                 {% endif %}
            </div>
        </div>

        {# Area for displaying existing reviews (List - TODO) #}
        <div class="existing-reviews">
             <h4>Reviews</h4>
            {# Loop through actual reviews later #}
             <p>(Review list will go here)</p>
        </div>
    </section>
    {# --- END: NEW Review Section --- #}


    {# --- START: Review Modal Popup (Hidden by default) --- #}
    {# Put this outside .main-content if you want full overlay, or inside #}
    <div class="modal" id="review-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="review-modal-title">
        <div class="modal-overlay" data-modal-close tabindex="-1"></div> {# Click outside to close #}
        <div class="modal-content">
             <button class="modal-close" data-modal-close aria-label="Close Review Modal">×</button>
             <h2 id="review-modal-title">Write a review</h2>
             {# Add Placeholder Reading Status? Requires Chapter Tracking #}
             {# <p class="reading-status">Reading Status: C1</p> #}

             {# This form needs to be updated later with backend fields #}
             <form method="post" class="review-form" action=""> {# Form POSTs to current page #}
                 {% csrf_token %}
                 {# Add hidden field if needed for update detection later #}

                {# Criteria Ratings - Placeholders (Needs proper form fields later) #}
                 <div class="review-criteria-ratings">
                    {# Example criterion (Repeat for others) #}
                    <div class="review-criterion-item">
                        <label for="id_writing_quality">Writing Quality</label> {# Associate with form field later #}
                         <div class="star-rating-input"> {# Re-use star input CSS #}
                             {# Need proper loop over form fields later #}
                             <input type="radio" name="writing_quality_placeholder" value="5" id="wq-5"><label for="wq-5"><svg><use xlink:href="#icon-star-filled"></use></svg></label>
                             <input type="radio" name="writing_quality_placeholder" value="4" id="wq-4"><label for="wq-4"><svg><use xlink:href="#icon-star-filled"></use></svg></label>
                             <input type="radio" name="writing_quality_placeholder" value="3" id="wq-3"><label for="wq-3"><svg><use xlink:href="#icon-star-filled"></use></svg></label>
                             <input type="radio" name="writing_quality_placeholder" value="2" id="wq-2"><label for="wq-2"><svg><use xlink:href="#icon-star-filled"></use></svg></label>
                             <input type="radio" name="writing_quality_placeholder" value="1" id="wq-1"><label for="wq-1"><svg><use xlink:href="#icon-star-filled"></use></svg></label>
                         </div>
                     </div>
                    {# --- Repeat similar blocks for other criteria --- #}
                    {# Stability of Updates #}
                    {# Story Development #}
                    {# Character Design #}
                    {# World Background #}

                     {# Example for total score in popup? Needs JS calculation usually #}
                    <div class="review-criterion-item total-score-display">
                        <label>The total score</label>
                         <div class="stars-display total-stars"> <span id="total-score-val">0.0</span> <svg><use xlink:href="#icon-star-empty"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg><svg><use xlink:href="#icon-star-empty"></use></svg> </div>
                     </div>
                 </div>

                 {# Text Review Area (Needs proper form field later) #}
                 <div class="review-text-area">
                     <textarea name="review_text_placeholder" rows="5" placeholder="Type your review here. Please write your review as detailed as you can. Your reviews would be very important to the story (at least 140 characters)."></textarea>
                 </div>

                  {# Form Footer with options/submit #}
                 <div class="modal-footer review-form-footer">
                     <div class="review-options">
                          {# Example placeholder options #}
                         {# <button type="button" class="icon-btn" aria-label="Attach Image">🖼️</button> #}
                         {# <button type="button" class="icon-btn" aria-label="Emojis">😊</button> #}
                         {# <label class="spoiler-toggle"><input type="checkbox" name="spoiler"> Spoiler</label> #}
                     </div>
                    <button type="submit" class="btn btn-primary post-review-btn">POST</button>
                 </div>
             </form> {# End Review Form #}

        </div> {# End modal-content #}
    </div> {# End #review-modal #}
    {# --- END: Review Modal Popup --- #}

</div> {# End .main-content #}

{% endblock content %}